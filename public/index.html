<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRUH</title>
    <style type="text/css">
        html, body{
            margin: 0;
            padding: 0;
            max-width: 100vw;
            overflow-x: hidden;
        }

        ::-webkit-scrollbar-track
        {
            -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.3);
            background-color: #F5F5F5;
            border-radius: 6px;
        }

        ::-webkit-scrollbar
        {
            width: 6px;
            background-color: #F5F5F5;
        }

        ::-webkit-scrollbar-thumb
        {
            border-radius: 10px;
            background-image: -webkit-gradient(linear,
                                            left bottom,
                                            left top,
                                            color-stop(0.44, rgb(122,153,217)),
                                            color-stop(0.72, rgb(73,125,189)),
                                            color-stop(0.86, rgb(28,58,148)));
        }

        .center{
            margin: 0 auto 0 auto;
            text-align: center;
        }

        .backsound{
            padding: 20px;
        }

        #app{
            position: relative;
        }

        canvas{
            margin: 0 auto 0 auto;
        }

        .russian-flag{
            background: linear-gradient(180deg, rgba(255,255,255,1) 33.33%, rgba(0,0,255,1) 33.34%, rgba(0,0,255,1) 66.66%, rgba(255,0,0,1) 66.67%);
            border: solid black 1px;
            color: cadetblue;
        }
    </style>
</head>
<body>
    <div class="header center">
        <h1><i>Welcome to <span class="russian-flag">OUR</span> Project</i></h1>
    </div>
    <div class="backsound center">
        <audio controls autoplay style="height:40px">
            <source src="./resource/backsound.mp3" type="audio/mpeg">
            Your browser does not support the audio element.
        </audio>
    </div>
    <div class="stuff center" id="app"></div>
    <div class="footer center">
        <i>* Demo is above this text</i>
    </div>
    <script type="x-shader/x-fragment" id="PCSS">
        #define LIGHT_WORLD_SIZE 0.005
        #define LIGHT_FRUSTUM_WIDTH 3.75
        #define LIGHT_SIZE_UV (LIGHT_WORLD_SIZE / LIGHT_FRUSTUM_WIDTH)
        #define NEAR_PLANE 9.5

        #define NUM_SAMPLES 17
        #define NUM_RINGS 11
        #define BLOCKER_SEARCH_NUM_SAMPLES NUM_SAMPLES
        #define PCF_NUM_SAMPLES NUM_SAMPLES

        vec2 poissonDisk[NUM_SAMPLES];

        void initPoissonSamples( const in vec2 randomSeed ) {
            float ANGLE_STEP = PI2 * float( NUM_RINGS ) / float( NUM_SAMPLES );
            float INV_NUM_SAMPLES = 1.0 / float( NUM_SAMPLES );

            // jsfiddle that shows sample pattern: https://jsfiddle.net/a16ff1p7/
            float angle = rand( randomSeed ) * PI2;
            float radius = INV_NUM_SAMPLES;
            float radiusStep = radius;

            for( int i = 0; i < NUM_SAMPLES; i ++ ) {
                poissonDisk[i] = vec2( cos( angle ), sin( angle ) ) * pow( radius, 0.75 );
                radius += radiusStep;
                angle += ANGLE_STEP;
            }
        }

        float penumbraSize( const in float zReceiver, const in float zBlocker ) { // Parallel plane estimation
            return (zReceiver - zBlocker) / zBlocker;
        }

        float findBlocker( sampler2D shadowMap, const in vec2 uv, const in float zReceiver ) {
            // This uses similar triangles to compute what
            // area of the shadow map we should search
            float searchRadius = LIGHT_SIZE_UV * ( zReceiver - NEAR_PLANE ) / zReceiver;
            float blockerDepthSum = 0.0;
            int numBlockers = 0;

            for( int i = 0; i < BLOCKER_SEARCH_NUM_SAMPLES; i++ ) {
                float shadowMapDepth = unpackRGBAToDepth(texture2D(shadowMap, uv + poissonDisk[i] * searchRadius));
                if ( shadowMapDepth < zReceiver ) {
                    blockerDepthSum += shadowMapDepth;
                    numBlockers ++;
                }
            }

            if( numBlockers == 0 ) return -1.0;

            return blockerDepthSum / float( numBlockers );
        }

        float PCF_Filter(sampler2D shadowMap, vec2 uv, float zReceiver, float filterRadius ) {
            float sum = 0.0;
            for( int i = 0; i < PCF_NUM_SAMPLES; i ++ ) {
                float depth = unpackRGBAToDepth( texture2D( shadowMap, uv + poissonDisk[ i ] * filterRadius ) );
                if( zReceiver <= depth ) sum += 1.0;
            }
            for( int i = 0; i < PCF_NUM_SAMPLES; i ++ ) {
                float depth = unpackRGBAToDepth( texture2D( shadowMap, uv + -poissonDisk[ i ].yx * filterRadius ) );
                if( zReceiver <= depth ) sum += 1.0;
            }
            return sum / ( 2.0 * float( PCF_NUM_SAMPLES ) );
        }

        float PCSS ( sampler2D shadowMap, vec4 coords ) {
            vec2 uv = coords.xy;
            float zReceiver = coords.z; // Assumed to be eye-space z in this code

            initPoissonSamples( uv );
            // STEP 1: blocker search
            float avgBlockerDepth = findBlocker( shadowMap, uv, zReceiver );

            //There are no occluders so early out (this saves filtering)
            if( avgBlockerDepth == -1.0 ) return 1.0;

            // STEP 2: penumbra size
            float penumbraRatio = penumbraSize( zReceiver, avgBlockerDepth );
            float filterRadius = penumbraRatio * LIGHT_SIZE_UV * NEAR_PLANE / zReceiver;

            // STEP 3: filtering
            //return avgBlockerDepth;
            return PCF_Filter( shadowMap, uv, zReceiver, filterRadius );
        }
    </script>
    <script type="x-shader/x-fragment" id="PCSSGetShadow">
        return PCSS( shadowMap, shadowCoord );
    </script>
    <script>
        const __windowConfig = Object.freeze(JSON.parse(`<%- window_config %>`));
        const __objectConfig = Object.freeze(JSON.parse(`<%- physic_config %>`));
    </script>
    <script type="text/javascript" src="./my-utils/environment.js"></script>
    <script type="text/javascript" src="./my-utils/operator.js"></script>
    <script type="module" src="./main.js"></script>
</body>
</html>